<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="public/styles/nav-styles.css">
	<link rel="stylesheet" href="public/styles/charts.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Home</title>
</head>
<body>
	<div id="navbar"></div>
	<div id="panes" class="main-content">
		<h1>Resources</h1>
		<a href="/public/class-proposal-form.html">Class Proposal Form</a>
		<a href="/class-proposals.html">Review Class Proposals</a>
		<h1 >Summary of Class Proposal Submissions</h1>
		<div class="chart-options span2">
			<label>Year
				<select id="year-select" class="year-select"></select>
			</label>
			<div class="vertical-seperator"></div>
			<label>Group By
				<select id="group-by" class="year-select">
					<option value="type">Type</option>
					<option value="level">Level</option>
					<option value="sessions">Sessions</option>
					<option value="length">Length</option>
				</select>
			</label>
			<div class="vertical-seperator"></div>
			<label>Sort A-Z
				<input type="checkbox" id="sort-alpha" checked>
			</label>
			<div class="spacer"></div>
			<label>Yes
				<input type="checkbox" id="yes" checked="true">
			</label>
			<div class="vertical-seperator"></div>
			<label>Maybe
				<input type="checkbox" id="maybe" checked="true">
			</label>
			<div class="vertical-seperator"></div>
			<label>No
				<input type="checkbox" id="no" checked="true">
			</label>
			<div class="vertical-seperator"></div>
			<label>Undecided
				<input type="checkbox" id="undecided" checked="true">
			</label>
		</div>
		<div class="graph">
			<canvas id="sub-bar"></canvas>
		</div>
	</div>
</body>
<script src="public/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', async () => {
		const res = await fetch('/auth/session', { credentials: 'include' });
		const user = await res.json();

		initHomePage()
	});

	function loadNavs(role) {
		const institute = document.createElement('span');
	}

	async function initHomePage() {
		await populateYearDropdown(document.getElementById('year-select'), 2);
		await loadData();
	}

	/* -----------------------------
	   Data Fetching
	----------------------------- */

	async function fetchProposalTypes() {
		const res = await fetch(`/api/getPropTypes`);
		if (!res.ok) throw new Error('Network error');
		return res.json();
	}

	/* -----------------------------
	   Page Setup
	----------------------------- */

	async function loadData() {
		try {
			const proposals = await fetchProposalTypes();

			let props = proposalChart(proposals);
			bindChartToggles(props);

			document.getElementById('year-select').addEventListener('change', () => { refreshChart(proposals, props) });
			document.getElementById('group-by').addEventListener('change', () => { refreshChart(proposals, props) });
			document.getElementById('sort-alpha').addEventListener('change', () => { refreshChart(proposals, props) });

		} catch (err) {
			console.error('Internal server error:', err);
		}
	}
	

	/* -----------------------------
	   Chart
	----------------------------- */

	function proposalChart(proposals, existingChart = null) {
		const groupBy = document.getElementById('group-by').value;

		const rows = sortRows(aggregateTotals(proposals, groupBy), groupBy);

		const labels = rows.map(r => r.label);

		const datasets = [
			{ label: 'Yes', backgroundColor: '#04AA6D', data: rows.map(r => r.yes) },
			{ label: 'Maybe', backgroundColor: '#FFC107', data: rows.map(r => r.maybe) },
			{ label: 'No', backgroundColor: 'red', data: rows.map(r => r.no) },
			{ label: 'Undecided', backgroundColor: 'blue', data: rows.map(r => r.undecided) }
		];

		if (existingChart) {
			existingChart.data.labels = labels;
			existingChart.data.datasets.forEach((ds, i) => {
				ds.data = datasets[i].data;
			});
			existingChart.update();
			return existingChart;
		}

		return new Chart("sub-bar", {
			type: "bar",
			data: { labels, datasets},
			options: {
				scales: { x: { stacked: true }, y: { stacked: true } },
				responsive: true,
				maintainAspectRatio: false
			}
		});
	}

	/* -----------------------------
		Helpers
	----------------------------- */
	function refreshChart(proposals, chart) {
		const yearSelect = document.getElementById('year-select');
		const selectedYear = yearSelect.options[yearSelect.selectedIndex].text;
		const filteredProposals = proposals.filter(p => p.year == selectedYear);

		proposalChart(filteredProposals, chart);
	}

	function isNumeric(value) {
		return value !== null && value !== '' && !isNaN(value);
	}

	function sortRows(rows, groupBy) {
		const sortAlpha = document.getElementById('sort-alpha')?.checked;

		if (sortAlpha) {
			if (groupBy === 'level') {
				return sortByOrderArray(rows, [
					'No Level',
					'Everyone',
					'Beginner',
					'Intermediate',
					'Advanced'
				]);
			}

			return rows.sort((a, b) => {
				const aNum = !isNaN(a.label);
				const bNum = !isNaN(b.label);

				if (aNum && bNum) {
					return Number(a.label) - Number(b.label);
				}

				return String(a.label).localeCompare(String(b.label), undefined, {
					numeric: true,
					sensitivity: 'base'
				});
			});
		}

		// default: volume
		return rows.sort((a, b) => b.total - a.total);
	}


	function sortByOrderArray(rows, order) {
		const index = new Map(order.map((v, i) => [String(v), i]));

		return rows.sort((a, b) => {
			const aKey = index.get(String(a.label));
			const bKey = index.get(String(b.label));

			// both found → ordered list wins
			if (aKey !== undefined && bKey !== undefined) {
				return aKey - bKey;
			}

			// only one found → known values first
			if (aKey !== undefined) return -1;
			if (bKey !== undefined) return 1;

			// fallback: natural sort
			return String(a.label).localeCompare(String(b.label), undefined, {
				numeric: true,
				sensitivity: 'base'
			});
		});
	}



	function aggregateTotals(proposals, groupBy) {
		const year = document.getElementById('year-select').selectedOptions[0].text;
		const data = proposals.filter(p => p.year == year);

		const map = {};

		data.forEach(p => {
			const key = p[groupBy];
			if (!map[key]) {
				map[key] = {
					label: key,
					yes: 0,
					maybe: 0,
					no: 0,
					undecided: 0,
					total: 0
				};
			}

			const count = Number(p.count) || 0;
			const state = p.approved ?? 'undecided';

			map[key][state] += count;
			map[key].total += count;
		});

		return Object.values(map);
	}


	function bindChartToggles(chart) {
		const map = {
			yes: 0,
			maybe: 1,
			no: 2,
			undecided: 3
		};

		Object.entries(map).forEach(([id, index]) => {
			document.getElementById(id).addEventListener('change', e => {
				chart.data.datasets[index].hidden = !e.target.checked;
				chart.update();
			});
		});
	}
</script>