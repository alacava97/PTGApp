<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Instructor Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Instructor Profile</h1>
		<div id="back-btn" class="back-btn"><a href="/instructors.html">&#9664; Instructors</a></div>
	</header>
	<h2 id="instructor-name" class="info-header">Loading...</h2>
	<h3>Contact</h3>
	<div id="instructor-details" class="row">No Contact Found</div>

	<div class="clearfix"><h3>Classes</h3>
	<div id="classes"></div>

	<h3>More Info</h3>
	<div id="more-info" class="row">No Extra Info</div>

	<br><br>

	<button id="delete-inst" class="delete-row">Delete Instructor</button>
</body>
<script src="public/js/script.js"></script>
<script src="public/js/modals.js"></script>
<script>
	async function getClasses(instructor_id) {
		try {
			const res = await fetch(`/api/classByInst/${instructor_id}`);
			if (!res.ok) throw new Error('Network error');

			const classList = await res.json();

			return classList;
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	document.addEventListener('DOMContentLoaded', async () => {
		const deleteInst = new Modal('delete-inst-modal');
		deleteInst.content(`<h4>Permanently delete instructor record?</h4>
			<div>
				<button id="delete-inst-button" class="button red modal-center">Delete</button>
			</div>`);

		const nameModal = new Modal('name-modal');
		nameModal.content(`<h4>Update Instructor Name</h4>
			<form id="name-form">
				<label for="name-input"></label>
				<input type="text" id="name-input" name="name" class="modal-center" placeholder="Instructor name">
				<br><br>
				<button type="submit" id="submit-name" class="button modal-center">Submit</button>
			</form>`);

		const sponsorModal = new Modal('sponsor-modal');
		sponsorModal.content(`<h4>Instructor Sponsor</h4>
			<form id="edit-sponsor">
				<label class="modal-center">Sponsored
					<input id="sponsored" class="small-input" type="checkbox" name="sponsored" class="modal-center">
				</label><br><br>
				<input type="text" name="sponsor" autocomplete="off" placeholder="Sponsor" class="modal-center" id="sponsor"><br><br>
				<button type="submit" class="button modal-center">Update Sponsor</button>
			</form>`);

		const classModal = new Modal('class-modal');
		classModal.content(`<h4>Select a Class</h4>
			<form id="instructor-class-form">
			    <input name="title" type="text" id="searchable" placeholder="Search classes" class="modal-center">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit" class="button modal-center">Add Class</button>
			</form>`);

		const delConfModal = new Modal('delete-confirmation-modal');
		delConfModal.content(`<h4>Remove class from instructor record?</h4>
			<div>
				<button id="delete-button" class="button red modal-center">Delete</button>
			</div>`);

		const contactModal = new Modal('contact-modal');
		contactModal.content(`<h4>Instructor Contact</h4>
			<form id="edit-contact">
				<input type="text" name="name"required class="modal-center" placeholder="Instructor name">
				<br><br>
				<input type="email" name="email" class="modal-center" placeholder="Email">
				<br><br>
				<input type="tel" name="phone" class="modal-center" placeholder="Phone">
				<br><br>
				<label class="modal-center">RPT Status
					<input class="small-input" type="checkbox" name="rpt" class="modal-center">
				</label><br><br>
				<button type="submit" class="button modal-center">Update Record</button>
				<div id="message"></div>
			</form>`);

		const id = getInstructorId();

		await populateModals(id);
		await loadInstructor(id);
		sponsorCheck();

		const contact = document.getElementById('instructor-details');
		const classes = document.getElementById('classes');
		const moreInfo = document.getElementById('more-info');

		contact.addEventListener('click', () => {
			const modal = document.getElementById('contact-modal')
			modal.style.display = "flex";
			modal.querySelector('#message').innerHTML = '';
		});

		moreInfo.addEventListener('click', () => {
			document.getElementById('sponsor-modal').style.display = "flex";
		});

	    const delClass = document.getElementById('delete-inst');
	    delClass.addEventListener('click', () => {
	    	document.getElementById('delete-inst-modal').style.display = 'flex';
	    });

	    document.getElementById('delete-inst-button').addEventListener('click', async () => {
    		await deleteEntry('instructors', id);
    		window.location.href = "/instructors.html"
	    })

		document.querySelectorAll('form').forEach(form => {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				if (form.id === 'instructor-class-form') {
					const data = parseForm(form);
					await linkInstructorToClass(id, data.title);
					await loadInstructor(id);
					const classModal = form.closest('.modal')
					classModal.style.display = 'none';
					form.reset();
				} else {
					const id = getInstructorId();
					handleFormSubmission(e, form, `/api/update/instructors/${id}`, 'PATCH', async () => {
						await populateModals(id);
						await loadInstructor(id);
					});
				}
			});
		});

		const sponsored = document.getElementById('sponsored');
		sponsored.addEventListener('change', sponsorCheck);

		const classData = await read('classes');
		const titles = classData.map(item => item.title);
		createSearchableDropdown('searchable', 'results', titles);
	});

	function getInstructorId() {
		return new URLSearchParams(window.location.search).get('id');
	}

</script>
</html>