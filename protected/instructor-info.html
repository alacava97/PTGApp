<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Instructor Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Instructor Profile</h1>
		<div id="back-btn" class="back-btn"><a href="/instructors.html">&#9664; Instructors</a></div>
	</header>
	<h2 id="instructor-name" class="info-header">Loading...</h2>
	<h3>Contact</h3>
	<div id="instructor-details">No Contact Found</div>

	<div class="clearfix"><h3>Classes</h3>
	<div id="classes"></div>

	<h3>More Info</h3>
	<div id="more-info">No Extra Info</div>

	<br><br>

	<button id="delete-inst" class="delete-row">Delete Instructor</button>
</body>
<script src="public/js/script.js"></script>
<script src="public/js/modals.js"></script>
<script src="public/js/UI.js"></script>
<script>
	async function getClasses(instructor_id) {
		try {
			const res = await fetch(`/api/classByInst/${instructor_id}`);
			if (!res.ok) throw new Error('Network error');

			const classList = await res.json();

			return classList;
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	document.addEventListener('DOMContentLoaded', async () => {
		const id = getInstructorId();

		await populateModals(id);
		await loadInstructor(id);
		sponsorCheck();

	    document.getElementById('delete-inst-button').addEventListener('click', async () => {
    		await deleteEntry('instructors', id);
    		window.location.href = "/instructors.html"
	    });

		document.querySelectorAll('form').forEach(form => {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				if (form.id === 'instructor-class-form') {
					const data = parseForm(form);
					await linkInstructorToClass(id, data.title);
					await loadInstructor(id);
					const classModal = form.closest('.modal')
					classModal.style.display = 'none';
					form.reset();
				} else {
					const id = getInstructorId();
					handleFormSubmission(e, form, `/api/update/instructors/${id}`, 'PATCH', async () => {
						await populateModals(id);
						await loadInstructor(id);
					});
				}
			});
		});

		const sponsored = document.getElementById('sponsored');
		sponsored.addEventListener('change', sponsorCheck);

		const classData = await read('classes');
		const titles = classData.map(item => item.title);
		createSearchableDropdown('searchable', 'results', titles);
	});

	function getInstructorId() {
		return new URLSearchParams(window.location.search).get('id');
	}

	async function loadInstructor(id = getInstructorId()) {
		//initialize modals
		const deleteInst = new Modal('delete-inst-modal');
		deleteInst.content(`<h4>Permanently delete instructor record?</h4>
			<div>
				<button id="delete-inst-button" class="button red modal-center">Delete</button>
			</div>`);
		document.getElementById('delete-inst').addEventListener('click', () => deleteInst.show());

		const nameModal = new Modal('name-modal');
		nameModal.content(`<h4>Update Instructor Name</h4>
			<form id="name-form">
				<label for="name-input"></label>
				<input type="text" id="name-input" name="name" class="modal-center" placeholder="Instructor name">
				<br><br>
				<button type="submit" id="submit-name" class="button modal-center">Submit</button>
			</form>`);

		const sponsorModal = new Modal('sponsor-modal');
		sponsorModal.content(`<h4>Instructor Sponsor</h4>
			<form id="edit-sponsor">
				<label class="modal-center">Sponsored
					<input id="sponsored" class="small-input" type="checkbox" name="sponsored" class="modal-center">
				</label><br><br>
				<input type="text" name="sponsor" autocomplete="off" placeholder="Sponsor" class="modal-center" id="sponsor"><br><br>
				<button type="submit" class="button modal-center">Update Sponsor</button>
			</form>`);

		const classModal = new Modal('class-modal');
		classModal.content(`<h4>Select a Class</h4>
			<form id="instructor-class-form">
			    <input name="title" type="text" id="searchable" placeholder="Search classes" class="modal-center">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit" class="button modal-center">Add Class</button>
			</form>`);

		const delConfModal = new Modal('delete-confirmation-modal');
		delConfModal.content(`<h4>Remove class from instructor record?</h4>
			<div>
				<button id="delete-button" class="button red modal-center">Delete</button>
			</div>`);

		const contactModal = new Modal('contact-modal');
		contactModal.content(`<h4>Instructor Contact</h4>
			<form id="edit-contact">
				<input type="text" name="name"required class="modal-center" placeholder="Instructor name">
				<br><br>
				<input type="email" name="email" class="modal-center" placeholder="Email">
				<br><br>
				<input type="tel" name="phone" class="modal-center" placeholder="Phone">
				<br><br>
				<label class="modal-center">RPT Status
					<input class="small-input" type="checkbox" name="rpt" class="modal-center">
				</label><br><br>
				<button type="submit" class="button modal-center">Update Record</button>
				<div id="message"></div>
			</form>`);

		try {
			const res = await fetch(`/api/readEntry/instructors/${id}`);
			if (!res.ok) throw new Error('Network error');

			const instructor = await res.json();

			var instTitle = instructor.name;
			if (instructor.rpt == true) {
				instTitle += ", RPT";
			}

			instTitle += "✎";

			//set title
			const name = document.getElementById('instructor-name');
			name.textContent = instTitle;
			name.addEventListener('click', () => { nameModal.show() });
			
			//contact section
			const contact = new Row();
			contact.addTitle(instTitle);
			contact.addSubtitle(instructor.email || 'No email on record.');
			contact.addSubtitle(instructor.phone || 'No phone on record.');
			contact.editArrow();
			contact.row.addEventListener('click', () => contactModal.show());

			const contactContainer = document.getElementById('instructor-details');
			contactContainer.replaceChildren(contact.row);

			//Classes
			const classes = await getClasses(id);
			const classContainer = document.getElementById('classes');
			classes.forEach(entry => {
				const classRow = new Row();
				classRow.addTitle(entry.title);
				classRow.addSubtitle(entry.type_name);
				classRow.addSubtitle(entry.level);
				classRow.addLink(`/class-info.html?id=${entry.class_id}`);
				classRow.addDeleteButton();
				classRow.deleteButton.addEventListener('click', (e) => {
					e.stopPropagation();
					delConfModal.show();
					const confDel = document.getElementById('delete-button');

					const newConfDel = confDel.cloneNode(true);
					confDel.parentNode.replaceChild(newConfDel, confDel);

					const id = getInstructorId();
					newConfDel.addEventListener('click', async () => {
						deleteClassInstructorLink(entry.class_id, id);
						loadInstructor(id);
						delModal.style.display = "none";
					});
				});
				classContainer.appendChild(classRow.row);
			});
			const addClass = new Row();
			addClass.addSubtitle(`<b>＋</b> Add class`);
			addClass.subtitle.addEventListener('click', () => classModal.show());
			classContainer.appendChild(addClass.row);

			//sponsor section
			const moreInfoContainer = document.getElementById('more-info');
			const moreInfo = new Row();
			if (instructor.sponsored === true) {
				moreInfo.addTitle(`Sponsored Instructor`);
				moreInfo.addSubtitle(instructor.sponsor || 'No sponsor on record');
			} else {
				moreInfo.addSubtitle('No Extra Info');
			}
			moreInfo.editArrow();
			moreInfo.row.addEventListener('click', () => sponsorModal.show());
			moreInfoContainer.replaceChildren(moreInfo.row);

		} catch (err) {
			console.error('Error loading instructor:', err);
			document.getElementById('instructor-name').textContent = 'Error loading instructor.';
		}
	}

</script>
</html>