<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="auth_pages/buttons/buttons.css">
	<link rel="stylesheet" href="modal.css">
	<link rel="stylesheet" href="auth_pages/themes.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Class Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Class Info</h1>
		<div id="back-btn" class="back-btn"><a href="/classes.html">&#9664; Classes</a></div>
	</header>
	<h2 id="class-title" class="info-header">Loading...</h2>
	<h3>Instructors</h3>
	<div id="instructors">No Instructors Found</div>

	<div class="modal" id="instructor-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Select an Instructor</h4>
			<form id="instructor-class-form">
			    <input name="instructor_name" type="text" id="searchable" placeholder="Search classes" class="modal-center">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit" class="button modal-center">Add Instructor</button>
			</form>
		</div>
	</div>

	<h3>Length</h3>
	<div id="length" class="row flex-row"></div>

	<h3>Type</h3>
	<div id="type" class="row flex-row">No Type Found</div>

	<h3>Level</h3>
	<div id="level" class="row flex-row">No Level Found</div>

	<br><br>

	<button id="delete-class" class="delete-row">Delete Class</button>

	<div class="modal" id="delete-confirmation-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Remove instructor from class record?</h4>
			<div>
				<button id="delete-button" class="button red modal-center">Delete</button>
			</div>
		</div>
	</div>

	<div class="modal" id="type-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Update Type</h4>
			<form id="type-form">
				<label for="type-select"></label>
				<select name="type" id="type-select" class="modal-center"></select>
				<br><br>
				<button type="submit" id="submit-type" class="button modal-center">Submit</button>
			</form>
		</div>
	</div>

	<div class="modal" id="level-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Update Level</h4>
			<form id="level-form">
				<label for="level-select"></label>
				<select name="level" id="level-select" class="modal-center">
					<option value="everyone">Everyone</option>
					<option value="beginner">Beginner</option>
					<option value="intermediate">Intermediate</option>
					<option value="advanced">Advanced</option>
				</select>
				<br><br>
				<button type="submit" id="submit-level" class="button modal-center">Submit</button>
			</form>
		</div>
	</div>

	<div class="modal" id="length-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Update Class Length</h4>
			<form id="length-form">
				<label for="length-input"></label>
				<input type="number" min="1" max="5" id="length-input" name="length" class="modal-center">
				<br><br>
				<button type="submit" id="submit-length" class="button modal-center">Submit</button>
			</form>
		</div>
	</div>

	<div class="modal" id="title-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Update Class Title</h4>
			<form id="title-form">
				<label for="title-input"></label>
				<input type="text" id="title-input" name="title" class="modal-center">
				<br><br>
				<button type="submit" id="submit-title" class="button modal-center">Submit</button>
			</form>
		</div>
	</div>

	<div class="modal" id="delete-class-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Permanently delete class record?</h4>
			<div>
				<button id="delete-class-button" class="button red modal-center">Delete</button>
			</div>
		</div>
	</div>
</body>
<script src="script.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', async () => {
		const delClass = document.getElementById('delete-class');
	    delClass.addEventListener('click', () => {
	    	document.getElementById('delete-class-modal').style.display = 'flex';
	    });

	    document.getElementById('delete-class-button').addEventListener('click', async () => {
    		await deleteEntry('classes', id);
    		window.location.href = "/classes.html"
	    })
	    
	    const id = getId();

	    // Initial page load
	    await loadClasses(id);
	    modalButtons();

	    // Build instructor dropdown
	    const instructorData = await read('instructors');
	    const instructors = instructorData.map(item => item.name);
	    await createSearchableDropdown('searchable', 'results', instructors);

	    const typeDD = document.getElementById('type-select');
	    await populateDropdown(typeDD, 'types', 'type');

	    // Attach submit handlers
	    document.querySelectorAll('form').forEach(form => {
	        form.addEventListener('submit', async (e) => {
	            e.preventDefault();

	            if (form.id === 'instructor-class-form') {
	                // Link instructor to class
	                const data = parseForm(form);
	                try {
	                    await linkClasstoInstructor({
	                        class_id: id,
	                        instructor_name: data.instructor_name
	                    });
	                    await loadClasses(id);
	                    closeModal(form);
	                    form.reset();
	                } catch (err) {
	                    console.error('Error linking instructor to class:', err);
	                }
	            } else {
	                // Update other class data
	                try {
	                    await handleFormSubmission(e, form, `/api/update/classes/${id}`, 'PATCH', async () => {
	                        await loadClasses(id);
	                    });
	                    closeModal(form);
	                    form.reset();
	                } catch (err) {
	                    console.error('Error updating class:', err);
	                }
	            }
	        });
	    });
	});

	// Utility: closes the modal containing a given form
	function closeModal(form) {
	    const modal = form.closest('.modal');
	    if (modal) modal.style.display = 'none';
	}

	async function loadClasses(class_id) {
		try {
			const res = await fetch(`/api/readEntry/classes/${class_id}`)
			if(!res.ok) throw new Error('Network error');

			const classRecord = await res.json();

			const title = document.getElementById('class-title');
			title.innerHTML = `${classRecord.title} ✎`
			title.addEventListener('click', () => {
				document.getElementById('title-modal').style.display = "flex";
				document.getElementById('title-input').value = classRecord.title;
			});

			const classes = await getClasses(class_id);
			renderInstructorList(classes, class_id);

		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	function renderInstructorList(instClasses, classId) {
		const instructors = document.getElementById('instructors');
		instructors.innerHTML = '';

		instClasses.forEach(entry => {
			const fullRow = document.createElement('div');
			fullRow.classList.add('flex-row');

			const instRow = document.createElement('span');
			instRow.classList.add('class-row-content');
			instRow.innerHTML = `<b>${entry.instructor_name}</b>`

			instRow.addEventListener('click', () => {
				window.location.href = `/instructor-info.html?id=${entry.instructor_id}`
			});

			const delBtn = document.createElement('div');
			delBtn.classList.add('delete-btn');
			delBtn.innerHTML = `&times;`

			delBtn.addEventListener('click', () => {
				const delModal = document.getElementById('delete-confirmation-modal')
				delModal.style.display = 'flex';

				const confDel = document.getElementById('delete-button');

				const newConfDel = confDel.cloneNode(true);
				confDel.parentNode.replaceChild(newConfDel, confDel);

				const id = getId();
				newConfDel.addEventListener('click', async () => {
					deleteClassInstructorLink(id, entry.instructor_id);
					loadClasses(id);
					delModal.style.display = "none";
				});
			});

			fullRow.appendChild(instRow);
			fullRow.appendChild(delBtn)
			instructors.appendChild(fullRow);
		});

		//add instructor button
		const addInst = document.createElement('div');
		addInst.classList.add('row');
		addInst.innerHTML = `<b>＋</b> Add instructor`
		instructors.appendChild(addInst);	
		addInst.addEventListener('click', () => {
			document.getElementById('instructor-modal').style.display = "flex";
		});

		//change class length
		const classLength = document.getElementById('length');
		classLength.textContent = `${instClasses[0].length} ${instClasses[0].length == 1 ? 'period' : 'periods'}`;
		classLength.style.fontWeight = 'bold';
		classLength.addEventListener('click', () => {
			document.getElementById('length-modal').style.display = 'flex';
			document.getElementById('length-input').value = instClasses[0].length;
		});

		//change class type
		const classType = document.getElementById('type');
		if (instClasses[0].type_name) {
			classType.textContent = instClasses[0].type_name;
			classType.style.fontWeight = 'bold';
		};
		classType.addEventListener('click', () => {
			document.getElementById('type-modal').style.display = "flex";
			document.getElementById('type-select').value = instClasses[0].type_id;
		});

		//change class level
		const classLevel = document.getElementById('level');
		const level = instClasses[0].level.toString();
		if (level) {
			classLevel.textContent = level.slice(0, 1).toUpperCase() + level.slice(1);
			classLevel.style.fontWeight = 'bold';
		};
		classLevel.addEventListener('click', () => {
			document.getElementById('level-modal').style.display = "flex";
			document.getElementById('level-select').value = instClasses[0].level;
		});
	}

	async function getClasses(class_id) {
		try {
			const res = await fetch(`/api/instByClass/${class_id}`);
			if (!res.ok) throw new Error('Network error');

			const instructorList = await res.json();

			return instructorList;
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

</script>
</html>