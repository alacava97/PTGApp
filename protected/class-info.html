<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Class Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Class Info</h1>
		<div id="back-btn" class="back-btn"><a href="/classes.html">&#9664; Classes</a></div>
	</header>
	<h2 id="class-title" class="info-header">Loading...</h2>
	<h3>Instructors</h3>
	<div id="instructors">Loading...</div>

	<h3>Length</h3>
	<div id="length">Loading...</div>

	<h3>Type</h3>
	<div id="type">Loading...</div>

	<h3>Level</h3>
	<div id="level">Loading...</div>

	<br><br>

	<button id="delete-class" class="delete-row">Delete Class</button>
</body>
<script src="public/js/script.js"></script>
<script src="public/js/modals.js"></script>
<script src="public/js/UI.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', async () => {
		await loadClass();
		const id = getId();

		const delClass = document.getElementById('delete-class');
	    delClass.addEventListener('click', () => delClassModal.show());

	    document.getElementById('delete-class-button').addEventListener('click', async () => {
    		await deleteEntry('classes', id);
    		window.location.href = "/classes.html";
	    });

	    // Build instructor dropdown
	    const instructorData = await read('instructors');
	    const instructors = instructorData.map(item => item.name);
	    await createSearchableDropdown('searchable', 'results', instructors);

	    const typeDD = document.getElementById('type-select');
	    await populateDropdown(typeDD, 'types', 'type');

	    // Attach submit handlers
	    document.querySelectorAll('form').forEach(form => {
	        form.addEventListener('submit', async (e) => {
	            e.preventDefault();

	            if (form.id === 'instructor-class-form') {
	                // Link instructor to class
	                const data = parseForm(form);
	                try {
	                    await linkClasstoInstructor({
	                        class_id: id,
	                        instructor_name: data.instructor_name
	                    });
	                    await refreshClass();
	                    form.reset();
	                } catch (err) {
	                    console.error('Error linking instructor to class:', err);
	                }
	            } else {
	                // Update other class data
	                try {
	                    await handleFormSubmission(e, form, `/api/update/classes/${id}`, 'PATCH', async () => {
	                        await refreshClass();
	                    });
	                    form.reset();
	                } catch (err) {
	                    console.error('Error updating class:', err);
	                }
	            }
	        });
	    });
	});

	async function loadClass(id = getId()) {
		const delClassModal = new Modal('delete-class-modal');
		delClassModal.content(`<h4>Permanently delete class record?</h4>
			<div>
				<button id="delete-class-button" class="button red modal-center">Delete</button>
			</div>`);

		const titleModal = new Modal('title-modal');
		titleModal.content(`<h4>Update Class Title</h4>
			<form id="title-form">
				<label for="title-input"></label>
				<input type="text" id="title-input" name="title" class="modal-center">
				<br><br>
				<button type="submit" id="submit-title" class="button modal-center">Submit</button>
			</form>`);

		const lengthModal = new Modal('length-modal');
		lengthModal.content(`<h4>Update Class Length</h4>
			<form id="length-form">
				<label for="length-input"></label>
				<input type="number" min="1" max="5" id="length-input" name="length" class="modal-center">
				<br><br>
				<button type="submit" id="submit-length" class="button modal-center">Submit</button>
			</form>`);

		const levelModal = new Modal('level-modal');
		levelModal.content(`<h4>Update Level</h4>
			<form id="level-form">
				<label for="level-select"></label>
				<select name="level" id="level-select" class="modal-center">
					<option value="everyone">Everyone</option>
					<option value="beginner">Beginner</option>
					<option value="intermediate">Intermediate</option>
					<option value="advanced">Advanced</option>
				</select>
				<br><br>
				<button type="submit" id="submit-level" class="button modal-center">Submit</button>
			</form>`);

		const typeModal = new Modal('type-modal');
		typeModal.content(`<h4>Update Type</h4>
			<form id="type-form">
				<label for="type-select"></label>
				<select name="type" id="type-select" class="modal-center"></select>
				<br><br>
				<button type="submit" id="submit-type" class="button modal-center">Submit</button>
			</form>`);

		const delConfModal = new Modal('delete-confirmation-modal');
		delConfModal.content(`<h4>Remove instructor from class record?</h4>
			<div>
				<button id="delete-button" class="button red modal-center">Delete</button>
			</div>`);

		const instModal = new Modal('instructor-modal');
		instModal.content(`<h4>Select an Instructor</h4>
			<form id="instructor-class-form">
			    <input name="instructor_name" type="text" id="searchable" placeholder="Search instructors" class="modal-center">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit" class="button modal-center">Add Instructor</button>
			</form>`);

		try {
			const res = await fetch(`/api/readEntry/classes/${id}`)
			if(!res.ok) throw new Error('Network error');

			const classRecord = await res.json();

			const title = document.getElementById('class-title');
			title.innerHTML = `${classRecord.title} ✎`
			title.addEventListener('click', () => {
				titleModal.show();
				document.getElementById('title-input').value = classRecord.title;
			});

			//instructors
			const instructorContainer = document.getElementById('instructors');
			const instClass = await getInstClass(id);
			if (instClass[0].instructor_name) { instructorContainer.innerHTML = '' };
			instClass.forEach(entry => {
				const instRow = new Row();
				instRow.addTitle(`${entry.instructor_name}`);
				instRow.addSubtitle(`${entry.sponsor || 'No sponsor'}`);
				instRow.addLink(`/instructor-info.html?id=${entry.instructor_id}`);
				instRow.addDeleteButton();
				instRow.deleteButton.addEventListener('click', (e) => {
					e.stopPropagation();
					delConfModal.show();
					const confDel = document.getElementById('delete-button');

					const newConfDel = confDel.cloneNode(true);
					confDel.parentNode.replaceChild(newConfDel, confDel);

					const id = getId();
					newConfDel.addEventListener('click', async () => {
						deleteClassInstructorLink(id, entry.instructor_id);
						refreshClass();
						delModal.style.display = "none";
					});
				})
				
				instructorContainer.appendChild(instRow.row);
			});

			const addInst = new Row();
			addInst.addSubtitle(`<b>＋</b> Add instructor`);
			addInst.row.addEventListener('click', () => { instModal.show() });
			instructorContainer.appendChild(addInst.row);

			//class length
			const classLength = document.getElementById('length');
			const length = new Row();
			if (instClass.length) {
				classLength.innerHTML = '';
				length.addTitle(`${instClass[0].length} ${instClass[0].length == 1 ? 'period' : 'periods'}`);
			} else {
				length.addTitle('No length');
			}
			length.row.addEventListener('click', () => {
				lengthModal.show();
				document.getElementById('length-input').value = instClass[0].length;
			});
			classLength.appendChild(length.row);

			//class type
			const classType = document.getElementById('type');
			const type = new Row();
			classType.innerHTML = '';
			type.addTitle(`${instClass[0].type_name || 'No type'}`);
			classType.addEventListener('click', () => {
				typeModal.show();
				document.getElementById('type-select').value = instClass[0].type_id;
			});
			classType.appendChild(type.row);

			//class level
			const classLevel = document.getElementById('level');
			const level = new Row();
			classLevel.innerHTML = '';
			const l = instClass[0].level.charAt(0).toUpperCase() + instClass[0].level.slice(1);
			level.addTitle(l || 'No level');
			level.row.addEventListener('click', () => {
				levelModal.show();
				document.getElementById('level-select').value = instClass[0].level;
			});
			classLevel.appendChild(level.row);
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	async function refreshClass(id = getId()) {
		try {
			const res = await fetch(`/api/readEntry/classes/${id}`)
			if(!res.ok) throw new Error('Network error');

			const classRecord = await res.json();

			const title = document.getElementById('class-title');
			title.innerHTML = `${classRecord.title} ✎`
			title.addEventListener('click', () => {
				document.getElementById('title-input').value = classRecord.title;
			});

			//instructors
			const instructorContainer = document.getElementById('instructors');
			const instClass = await getInstClass(id);
			if (instClass[0].instructor_name) { instructorContainer.innerHTML = '' };
			instClass.forEach(entry => {
				const instRow = new Row();
				instRow.addTitle(`${entry.instructor_name}`);
				instRow.addSubtitle(`${entry.sponsor || 'No sponsor'}`);
				instRow.addLink(`/instructor-info.html?id=${entry.instructor_id}`);
				instRow.addDeleteButton();
				instRow.deleteButton.addEventListener('click', (e) => {
					e.stopPropagation();
					delConfModal.show();
					const confDel = document.getElementById('delete-button');

					const newConfDel = confDel.cloneNode(true);
					confDel.parentNode.replaceChild(newConfDel, confDel);

					const id = getId();
					newConfDel.addEventListener('click', async () => {
						deleteClassInstructorLink(id, entry.instructor_id);
						refreshClass();
						delModal.style.display = "none";
					});
				})
				
				instructorContainer.appendChild(instRow.row);
			});

			const addInst = new Row();
			addInst.addSubtitle(`<b>＋</b> Add instructor`);
			addInst.row.addEventListener('click', () => { instModal.show() });
			instructorContainer.appendChild(addInst.row);

			//class length
			const classLength = document.getElementById('length');
			const length = new Row();
			if (instClass.length) {
				classLength.innerHTML = '';
				length.addTitle(`${instClass[0].length} ${instClass[0].length == 1 ? 'period' : 'periods'}`);
			} else {
				length.addTitle('No length');
			}
			length.row.addEventListener('click', () => {
				lengthModal.show();
				document.getElementById('length-input').value = instClass[0].length;
			});
			classLength.appendChild(length.row);

			//class type
			const classType = document.getElementById('type');
			const type = new Row();
			classType.innerHTML = '';
			type.addTitle(`${instClass[0].type_name || 'No type'}`);
			classType.addEventListener('click', () => {
				typeModal.show();
				document.getElementById('type-select').value = instClass[0].type_id;
			});
			classType.appendChild(type.row);

			//class level
			const classLevel = document.getElementById('level');
			const level = new Row();
			classLevel.innerHTML = '';
			const l = instClass[0].level.charAt(0).toUpperCase() + instClass[0].level.slice(1);
			level.addTitle(l || 'No level');
			level.row.addEventListener('click', () => {
				levelModal.show();
				document.getElementById('level-select').value = instClass[0].level;
			});
			classLevel.appendChild(level.row);
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	async function getInstClass(class_id) {
		try {
			const res = await fetch(`/api/instByClass/${class_id}`);
			if (!res.ok) throw new Error('Network error');

			const instructorList = await res.json();

			return instructorList;
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

</script>
</html>