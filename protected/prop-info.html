<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="public/styles/nav-styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>PTG Convention Web App</title>
</head>
<body>
	<div id="navbar"></div>
	<header class="clearfix">
		<h1>Class Proposal</h1>
		<div id="back-btn" class="back-btn"><a href="/class-proposals.html">&#9664; Classes</a></div>
	</header>
	<main class="prop-main">
		<h2>Class Details</h2>
		<h3>Class</h3>
		<div id="class-info">Loading...</div>
		<h3>Instructor</h3>
		<div id="instructor-info">Loading...</div>
		<h3>Sponsor</h3>
		<div id="sponsor-info">Loading...</div>
		<h2>Options</h2>
		<h3>Approval Status</h3>
		<div id="approved">Loading...</div>
		<h3>Assigned To</h3>
		<div id="assigned">Loading...</div>
		<h3>Number of Sessions</h3>
		<div id="periods">Loading...</div>
	</main>
</body>
<script src="public/js/script.js"></script>
<script src="public/js/modals.js"></script>
<script src="public/js/UI.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', initPropPage);

	async function initPropPage() {
		const proposalId = getId();

		await loadProposalData(proposalId);
	}

	/* -----------------------------
	   Data Fetching
	----------------------------- */

	async function fetchProposals(proposalId) {
		const res = await fetch(`/api/readEntry/class_proposals/${proposalId}`);
		if (!res.ok) throw new Error('Network error');
		return res.json();
	}

	/* -----------------------------
	   Page Setup
	----------------------------- */

	async function loadProposalData(proposalId) {
		try {
			const [proposalData] = await Promise.all([
				fetchProposals(proposalId)
			]);

			setupClassInfo(proposalData);
			setupInstructorInfo(proposalData);
			setupSponsorInfo(proposalData);
			setupApprove(proposalData);
			setupAssign(proposalData);
			setupPeriods(proposalData);
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	/* -----------------------------
	   Class Info
	----------------------------- */

	function setupClassInfo(data) {
		const container = document.getElementById('class-info');
		container.innerHTML = '';
		console.log(data)
		const row = new Row();
		const classInfo = document.getElementById('class-info');
		const classRow = new Row();
		classRow.addTitle(data.title || 'No Title');
		classRow.addSubtitle(`<b>Type:</b> ${data.type || 'No type'}`);
		classRow.addSubtitle(`<b>Level:</b> ${data.level || 'No level'}`);
		classInfo.replaceChildren(classRow.row);

		const descRow = new Row();
		descRow.addTitle('Class Description');
		descRow.addSubtitle(`${data.description || 'No description'}`);
		classInfo.appendChild(descRow.row);

		const moreRow = new Row();
		moreRow.addSubtitle(`<b>Length:</b> ${data.length || 0} ${data.length == 1 ? 'period' : 'periods'}`);
		moreRow.addSubtitle(`<b>Uprights:</b> ${data.uprights || 0} ${data.uprights == 1 ? 'upright' : 'uprights'}`);
		moreRow.addSubtitle(`<b>Grands:</b> ${data.grands || 0} ${data.grands == 1 ? 'grand' : 'grands'}`);
		classInfo.appendChild(moreRow.row);
	}

	/* -----------------------------
	   Instructor Info
	----------------------------- */

	function setupInstructorInfo(data) {
		const instInfo = document.getElementById('instructor-info');
		const instRow = new Row();
		instRow.addTitle(`${data.name || 'No Instructor'}`);
		instRow.addSubtitle(`<b>Email:</b> ${data.email || 'No email'}`);
		instRow.addSubtitle(`<b>Phone:</b> ${data.phone || 'No phone'}`);
		instInfo.replaceChildren(instRow.row);
	}

	/* -----------------------------
	   Sponsor Info
	----------------------------- */

	function setupSponsorInfo(data) {
		const sponsorInfo = document.getElementById('sponsor-info');
		const sponsorRow = new Row();
		sponsorRow.addSubtitle(`${data.sponsor || 'No Sponsor'}`);
		sponsorInfo.replaceChildren(sponsorRow.row);
	}

	/* -----------------------------
	   Approval Status
	----------------------------- */

	function setupApprove(data) {
		const container = document.getElementById('approved');

		const modal = new Modal('approve-modal');
		modal.content(`
			<h4>Update Class Details</h4>
			<form>
				<select name="approved" id="approve-select">
					<option value="yes">Yes</option>
					<option value="maybe">Maybe</option>
					<option value="no">No</option>
				</select>
				<div class="seperator"></div>
				<button type="submit">Submit</button>
			</form>
		`);

		let approved = data.approved;

		const approveRow = new Row();
		approveRow.addSubtitle(`${approved || 'Pending review'}`, 'approve-subtitle');
		approveRow.editArrow();

		approveRow.row.addEventListener('click', () => {
			modal.show();
			document.getElementById('approve-select').value = approved;
		})

		container.replaceChildren(approveRow.row);

		modal.formSubmit(async () => {
			const updated = await fetchProposals(data.id);
			approved = updated.approved;

			document.getElementById('approve-subtitle').innerHTML = `${approved || 'Pending review'}`
		}, 'class_proposals');
	}

	/* -----------------------------
	   Team Assignment
	----------------------------- */

	function setupAssign(data) {
		const container = document.getElementById('assigned');

		const modal = new Modal('approve-modal');
		modal.content(`
			<h4>Assign</h4>
			<form>
				<select id="assign-select" name="assigned">
					<option value=''>Select a Team Member</option>
				</select>
				<button type="submit" class="button">Assign</button>
			</form>
		`);

		const teamDD = document.getElementById('assign-select');
		populateDropdown(teamDD, 'institute_team', 'name')

		let teamMember = data.assigned;

		const assignRow = new Row();
		assignRow.addSubtitle(`${teamMember || 'Not assigned'}`, 'assign-subtitle')
		assignRow.editArrow();

		assignRow.row.addEventListener('click', () => {
			modal.show();
			document.getElementById('assign-select').value = teamMember || '';
		})

		container.replaceChildren(assignRow.row);

		modal.formSubmit(async () => {
			const updated = await fetchProposals(data.id);
			teamMember = updated.assigned;

			document.getElementById('assign-subtitle').innerHTML = `${teamMember || 'Not assigned'}`;
		}, 'class_proposals');
	}

	/* -----------------------------
	   Periods to Teach
	----------------------------- */

	function setupPeriods(data) {
		const container = document.getElementById('periods');

		const modal = new Modal('period-modal');
		modal.content(`
			<h4>Sessions to Teach</h4>
			<form>
				<input type="number" id="session-input" name="sessions">
				<button type="submit" class="button">Assign</button>
			</form>
		`);

		let sessions = data.sessions;

		const sessionRow = new Row();
		sessionRow.addSubtitle(`${sessions || 0}`, 'session-subtitle')
		sessionRow.editArrow();

		sessionRow.row.addEventListener('click', () => {
			modal.show();
			document.getElementById('session-input').value = sessions || 0;
		});

		container.replaceChildren(sessionRow.row);

		modal.formSubmit(async () => {
			const updated = await fetchProposals(data.id);
			sessions = updated.sessions;

			document.getElementById('session-subtitle').innerHTML = `${sessions || 0}`;
		}, 'class_proposals');
	}

	function loadNavs(role) {
		const institute = document.createElement('span');
	}
</script>