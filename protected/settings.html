<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/auth.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>PTG Convention Web App</title>
</head>
<body>
	<div id="navbar"></div>
	<header>
		<h1>Settings</h1>
	</header>
	<div class="flex-row-2">
		<div>
			<h2>Class Types</h2>
			<ul id="class-type-list" class="transparent type-ul"></ul>
			<button id="add-type" class="add-btn">+ Add Type</button>
		</div>
		<div>
			<h2>Rooms</h2>
			<ul id="room-list" class="transparent type-ul"></ul>
			<button id="add-room" class="add-btn">+ Add Type</button>
		</div>
	</div>
</body>
<script src="public/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
	  setupEditableSortableList({
	    table: 'types',
	    listId: 'class-type-list',
	    addButtonId: 'add-type',
	    displayKey: 'type',
	  });

	  setupEditableSortableList({
	  	table: 'rooms',
	  	listId: 'room-list',
	  	addButtonId: 'add-room',
	  	displayKey: 'name',
	  });
	});

	/**
	 * Reusable list handler for editable, sortable database-driven lists.
	 * 
	 * @param {Object} config
	 * @param {string} config.table - Table name for API routes
	 * @param {string} config.listId - ID of UL/OL element
	 * @param {string} config.addButtonId - ID of "Add" button
	 * @param {string} config.displayKey - Property name to display as text
	 */
	function setupEditableSortableList({ table, listId, addButtonId, displayKey }) {
	  const list = document.getElementById(listId);
	  const addBtn = document.getElementById(addButtonId);

	  if (!list) {
	    console.error(`List element #${listId} not found`);
	    return;
	  }

	  // --- Fetch + Render Existing Items ---
	  (async () => {
	    try {
	      const items = await read(table);
	      items.forEach(item => renderListItem(item));
	    } catch (err) {
	      console.error(`Failed to load ${table}:`, err);
	    }
	  })();

	  // --- Initialize Drag Sorting ---
	  new Sortable(list, {
	    animation: 150,
	    ghostClass: 'dragging',
	    onEnd: async () => {
	      const newOrder = [...list.children].map((li, index) => ({
	        id: li.dataset.id,
	        position: index + 1
	      }));

	      try {
	        await fetch('/api/update-order', {
	          method: 'PATCH',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ order: newOrder, table })
	        });
	      } catch (err) {
	        console.error('Failed to update order:', err);
	      }
	    }
	  });

	  // --- Add New Item ---
	  addBtn?.addEventListener('click', () => {
	    const li = document.createElement('li');
	    li.className = 'type-list new-item';
	    const input = document.createElement('input');
	    input.type = 'text';
	    input.placeholder = `New ${displayKey}...`;
	    input.classList.add('inline-edit');
	    li.appendChild(input);
	    list.appendChild(li);
	    input.focus();

	    const finalizeAdd = async () => {
	      const value = input.value.trim();
	      if (!value) return li.remove();
	      try {
	        const res = await fetch(`/api/create/${table}`, {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ [displayKey]: value })
	        });
	        const data = await res.json();
	        li.remove();
	        renderListItem(data);
	      } catch (err) {
	        console.error(`Add ${displayKey} failed:`, err);
	        li.remove();
	      }
	    };

	    input.addEventListener('keydown', e => {
	      if (e.key === 'Enter') finalizeAdd();
	      if (e.key === 'Escape') li.remove();
	    });
	    input.addEventListener('blur', finalizeAdd);
	  });

	  // --- Helper: Render a Single Item ---
	  function renderListItem(item) {
	    const li = document.createElement('li');
	    li.classList.add('type-list');
	    li.dataset.id = item.id;

	    const span = document.createElement('span');
	    span.textContent = item[displayKey];
	    li.appendChild(span);
	    attachInlineEdit(span, li);
	    attachDeleteButton(li);

	    list.appendChild(li);
	  }

	  // --- Helper: Inline Edit ---
	  function attachInlineEdit(span, li) {
	    span.addEventListener('click', () => {
	      const oldText = span.textContent;
	      const input = document.createElement('input');
	      input.type = 'text';
	      input.value = oldText;
	      input.classList.add('inline-edit');
	      span.textContent = '';
	      span.appendChild(input);
	      input.focus();

	      const save = async () => {
	        const newText = input.value.trim();
	        if (newText === oldText || !newText) return (span.textContent = oldText);

	        try {
	          const res = await fetch(`/api/update/${table}/${li.dataset.id}`, {
	            method: 'PATCH',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify({ [displayKey]: newText })
	          });
	          if (!res.ok) throw new Error('Update failed');
	          span.textContent = newText;
	        } catch (err) {
	          console.error(`Failed to update ${displayKey}:`, err);
	          span.textContent = oldText;
	        }
	      };

	      input.addEventListener('blur', save);
	      input.addEventListener('keydown', e => {
	        if (e.key === 'Enter') input.blur();
	        if (e.key === 'Escape') span.textContent = oldText;
	      });
	    });
	  }

	  // --- Helper: Delete Button ---
	  function attachDeleteButton(li) {
	    const del = document.createElement('button');
	    del.textContent = 'Ã—';
	    del.className = 'delete-btn2';
	    li.appendChild(del);

	    del.addEventListener('click', async e => {
	      e.stopPropagation();
	      const id = li.dataset.id;
	      if (!confirm(`Delete this ${displayKey}?`)) return;

	      try {
	        const res = await fetch(`/api/delete/${table}/${id}`, { method: 'DELETE' });
	        if (!res.ok) throw new Error('Delete failed');
	        li.remove();
	      } catch (err) {
	        console.error(`Delete ${displayKey} failed:`, err);
	      }
	    });
	  }
	}

</script>