<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="public/styles/nav-styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Audit Log</title>
</head>
<body>
	<div id="navbar"></div>
	<header class="clearfix">
		<h1>Audit Log</h1>
	</header>
	<section id="list"></section>
</body>
<script src="public/js/script.js"></script>
<script src="public/js/UI.js"></script>
<script>
	window.addEventListener('DOMContentLoaded', initAudit)

	async function initAudit() {
		await loadAuditLog();
	}

	/* -----------------------------
	   Data Fetching
	----------------------------- */

	async function fetchAudits() {
		const res = await fetch(`/api/read/audit_log`);
		if (!res.ok) throw new Error('Network error');
		return res.json();
	}	

	/* -----------------------------
	   Setup Page
	----------------------------- */

	async function loadAuditLog() {
		try {
			const [audits] = await Promise.all([
				fetchAudits()
			]);

			setupAudits(audits);
			console.log(audits);
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	/* -----------------------------
	   Audits
	----------------------------- */

	function setupAudits(audits) {
		const list = document.getElementById('list');

		Object.entries(audits)
			.reverse()
			.slice(0, 100)
			.forEach(([key, value]) => {
				const audit = audits[key];

				const row = new Row();
				row.addSubtitle(`<b>Action:</b> ${audit.action}`);
				row.addSeparator();
				row.addSubtitle(`<b>Timestamp:</b> ${new Date(audit.created_at)}`);
				row.addSeparator();
				row.addSubtitle(`<b>User:</b> ${audit.name}`);
				row.addSeparator();
				row.addSubtitle(`<b>Action:</b> ${audit.to_display}`);
				row.addSeparator();
				if (audit.action === 'UPDATE') {
					const diffs = diffObjectsSplit(audit.old_data ?? {}, audit.new_data ?? {});
					row.addSubtitle(`<b>Old Data:</b> ${JSON.stringify(diffs.oldValues)}`);
					row.addSeparator();
					row.addSubtitle(`<b>New Data:</b> ${JSON.stringify(diffs.newValues)}`);
				}
				list.appendChild(row.row);
			});
	}

	function diffObjectsSplit(a = {}, b = {}) {
	  if (!a || !b) {
	    return { oldValues: {}, newValues: {} };
	  }

	  const oldValues = {};
	  const newValues = {};

	  for (const key of Object.keys(a)) {
	    if (a[key] !== b[key]) {
	      oldValues[key] = a[key];
	      newValues[key] = b[key];
	    }
	  }

	  return { oldValues, newValues };
	}


</script>
</html>