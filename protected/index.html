<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>PTG Convention Web App</title>
</head>
<body>
	<div id="navbar"></div>
	<header>
		<h1>Schedule</h1>
	</header>
	<div id="color-key" class="key"></div>
	<div id="color-block" class="schedule grid"></div>

	<div class="modal" id="class-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Select a Class</h4>
			<p id="period-info"></p>
			<form id="schedule-form">
			    <input name="title" type="text" id="searchable" placeholder="Search classes" class="modal-center">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit" class="button modal-center">Add Class</button>
			</form>
		</div>
	</div>
	<div class="modal" id="event-modal">
		<div class="modal-content big-modal">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4><a id="class-title"></a></h4>
			<h5 id="inst"></h5>
			<p id="class-info"></p>
			<form id="update-sched">
				<label for="day">Day</label>
				<select id="day" name="day" class="modal-center">
					<option value="3" selected>Wednesday</option>
					<option value="4">Thursday</option>
					<option value="5">Friday</option>
					<option value="6">Saturday</option>
				</select><br><br>
				<label for="start_period">Period</label>
				<select id="start_period" name="start_period" class="modal-center">
					<option value="1">Period 1</option>
					<option value="2">Period 2</option>
					<option value="3">Period 3</option>
					<option value="4">Period 4</option>
					<option value="5">Period 5</option>
				</select><br><br>
				<label for="room">Room</label>
				<select name="room" id="room-select" class="modal-center"></select><br><br>
				<label for="notes">Notes</label>
				<textarea name="notes" placeholder="notes" id="notes" class="modal-center"></textarea><br>
				<button type="submit" id="edit-sched" class="button modal-center">Update</button>
			</form><br>
			<button id="confirm-delete" class="button red modal-center">Delete</button>
		</div>
		<div id="message"></div>
	</div>
	<div class="modal" id="delete-confirmation-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Remove event from calendar?</h4>
			<div>
				<button id="delete-button" class="button red modal-center">Delete</button>
			</div>
		</div>
	</div>
</body>
<script src="public/js/script.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', async () => {
		renderSchedule();
		modalButtons();
		setupScheduleForm();

		const classData = await read('classes');
		const titles = classData.map(item => item.title);
		createSearchableDropdown('searchable', 'results', titles);

		const rooms = await read('rooms');
		const roomDD = document.getElementById('room-select');
		Object.values(rooms).forEach(obj => {
			const opt = document.createElement('option');
			const room = Object.values(obj)[1];
			opt.value = room;
			opt.textContent = room;
			roomDD.appendChild(opt);
		});

		populateKey();
	});

	async function renderSchedule() {
		//render headers
		const calendar = document.getElementById('color-block');
		calendar.innerHTML = '';

		const roomCol = document.createElement('div');
		roomCol.classList.add('cal-col', 'blank');
		calendar.appendChild(roomCol);

		const days = ['Wednesday', 'Thursday', 'Friday', 'Saturday'];
		const periods = [1, 2, 3, 4, 5];
		days.forEach(day => {
			const calDay = document.createElement('div');
			const dayLabel = document.createElement('div');
			dayLabel.textContent = day;
			dayLabel.classList.add('day-label');
			calDay.appendChild(dayLabel);
			calDay.classList.add('cal-day', 'day-period');

			periods.forEach(period => {
				const block = document.createElement('div');
				block.textContent = period;
				block.classList.add('period');
				calDay.appendChild(block);
			})
			calendar.appendChild(calDay);
		});

		try {
			const schedRes = await fetch(`/api/schedule`, { credentials: 'include' });
			const schedule = await schedRes.json();
			const roomRes = await fetch(`/api/read/rooms`);
			const rooms = await roomRes.json();

			for (const key in rooms) {
				const room = document.createElement('div');
				const roomName = rooms[key]['name'];
				room.textContent = roomName
				room.classList.add('cal-col');
				calendar.appendChild(room);
				days.forEach((day, index) => {
				  	const roomDay = document.createElement('div');
				  	roomDay.classList.add('cal-day');

					const events = schedule.filter(e => e.day == (index + 3) && e.room == roomName);

					// check for overlaps
					const overlaps = checkOverlap(events);
					if (overlaps.length > 0) {
					  overlaps.forEach(o => {
					    console.warn(`Overlap detected in room "${roomName}" on ${day}: "${o.eventA.title}" at period ${o.eventA.start_period} overlaps with "${o.eventB.title}" at period ${o.eventB.start_period}`);
					  });
					}

				  // --- grid rendering with dummy cells ---
					let p = 1;
					while (p <= periods.length) {
					  const periodEvent = events.find(ev => ev.start_period == p);

					  if (periodEvent) {
					    const eventDiv = document.createElement('div');
					    eventDiv.classList.add('room-period');
					    eventDiv.textContent = periodEvent.title;
					    eventDiv.style.backgroundColor = periodEvent.color;

					    const start = Number(periodEvent.start_period);
					    const end = start + Number(periodEvent.length) - 1; // compute end from length
					    eventDiv.style.gridColumn = `${start} / ${end + 1}`;
					    eventDiv.id = periodEvent.schedule_id;

					    eventDiv.addEventListener('click', () => {
					      const eventModal = document.getElementById('event-modal');
					      eventModal.style.display = 'flex';

					      const eventTitle = document.getElementById('class-title')
					      eventTitle.innerHTML = `${periodEvent.title} &#9998;`;
					      eventTitle.href = `/class-info.html?id=${periodEvent.class_id}`

					      document.getElementById('inst').textContent = periodEvent.instructors;
					      document.getElementById('day').value = periodEvent.day;
					      document.getElementById('start_period').value = periodEvent.start_period;
					      document.getElementById('room-select').value = periodEvent.room;

					      const form = document.getElementById('update-sched');
					      form.addEventListener('submit', (e) => {
					      	e.preventDefault();
					      	const id = periodEvent.schedule_id;
					      	handleFormSubmission(e, form, `/api/update/schedule/${id}`, 'PATCH', async () => {
								renderSchedule();
							});
					      })

					      const delButton = document.getElementById('confirm-delete');
					      delButton.addEventListener('click', () => {
					      	document.getElementById('delete-confirmation-modal').style.display = 'flex';
					      	deleteButton(periodEvent.schedule_id, renderSchedule);
					      });
					    });

					    roomDay.appendChild(eventDiv);

					    p = end + 1; // skip past this event
					  } else {
					    const dummy = document.createElement('div');
					    dummy.classList.add('room-period', 'empty');
					    dummy.textContent = p; 
					    dummy.id = 0;
					    const currentPeriod = p;
					    const form = document.getElementById('schedule-form');

					    dummy.addEventListener('click', async () => {
					      document.getElementById('searchable').value = '';
					      document.getElementById('results').innerHTML = '';
					      document.getElementById('class-modal').style.display = 'flex';
					      document.getElementById('period-info').textContent = `${day} - Period ${currentPeriod} - ${roomName}`;

					      form.dataset.day = index + 3;
					      form.dataset.period = currentPeriod;
					      form.dataset.room = roomName;
					    });

					    roomDay.appendChild(dummy);
					    p++;
					  }
					}
				  calendar.appendChild(roomDay);
				});
			}
		} catch (err) {
			console.error('Error loading schedule:', err);
		}
	}

	function setupScheduleForm() {
	  const form = document.getElementById('schedule-form');
	  if (!form) return; // guard

	  form.addEventListener('submit', async (e) => {
	    e.preventDefault();

	    const day = parseInt(form.dataset.day);
	    const start_period = parseInt(form.dataset.period);
	    const room = form.dataset.room;
	    const title = document.getElementById('searchable').value;

	    try {
	      // Fetch class info to get length
	      const classRes = await fetch('/api/read/classes');
	      const classes = await classRes.json();
	      const selectedClass = classes.find(c => c.title == title);

	      if (!selectedClass) {
	        alert(`Class "${title}" not found`);
	        return;
	      }

	      const length = selectedClass.length;
	      const newEnd = start_period + length - 1;

	      // Check period limit (cannot exceed 5)
	      if (newEnd > 5) {
	        alert(`Cannot schedule "${title}" after period 5`);
	        return;
	      }

	      // Fetch current schedule
	      const schedRes = await fetch('/api/schedule');
	      const schedule = await schedRes.json();

	      // Existing events in this room/day
	      const roomEvents = schedule.filter(e => e.day == day && e.room == room);

	      // Check for overlap
	      const newEvent = { Number(start_period), Number(length), Number(day), room, title };
	      const allEvents = [...roomEvents, newEvent];

	      const overlaps = checkOverlap(allEvents);

	      const hasOverlap = overlaps.some(o =>
	        o.eventA == newEvent || o.eventB == newEvent
	      );

	      if (hasOverlap) {
			alert(`Cannot add "${title}" because it overlaps with "${overlap.title}" at period ${overlap.start_period}`);
			return;
	      }

	      // No conflicts â†’ submit to backend
	      const res = await fetch('/api/addSchedule', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ title, day, start_period, room })
	      });

	      if (!res.ok) throw new Error(await res.text());

	      alert('Class added!');
	      document.getElementById('class-modal').style.display = 'none';

	      // Refresh schedule display
	      await renderSchedule();

	      // Clear form
	      form.dataset.day = '';
	      form.dataset.period = '';
	      form.dataset.room = '';
	      document.getElementById('searchable').value = '';
	      document.getElementById('results').innerHTML = '';

	    } catch (err) {
	      console.error('Error adding class:', err);
	      alert('Failed to add class.');
	    }
	  });
	}

	function deleteButton(id, onSuccess) {
		const button = document.getElementById('delete-button');
		const freshButton = button.cloneNode(true);
		button.parentNode.replaceChild(freshButton, button);

		freshButton.addEventListener('click', async () => {
			try {
				const res = await fetch(`/api/delete/schedule/${id}`, { 
						method: 'DELETE'
					});

				const data = await res.json();

				if (!res.ok) {
					alert(`Error: ${data.error}`);
					return;
				}

				if (typeof onSuccess == "function") {
					onSuccess();
				}
				alert('event deleted');
				document.querySelectorAll('.modal').forEach(modal => {
					modal.style.display = 'none';
				})
			} catch (err) {
				console.error(err);
				alert('Failed to delete entry');
			}
		})
	}

	async function populateKey() {
		try {
			const res = await fetch('/api/read/types');
			const data = await res.json();

			if (!res.ok) {
				console.error(`Error: ${data.error}`);
				return;
			}

			const key = document.getElementById('color-key');

			data.forEach(type => {
				const keyType = document.createElement('div');
				keyType.style.backgroundColor = type.color;
				keyType.classList.add('key-item');

				keySelect = document.createElement('input');
				keySelect.type = 'color';
				keySelect.value = type.color;
				keySelect.dataset = type.id;
				keySelect.classList.add('color-select');
				keySelect.addEventListener('blur', async (event) => {
					const val = event.target.value;
					const id = type.id;
					const data = { 'color': val };
					try {
						const res = await fetch(`/api/update/types/${id}`, {
							method: 'PATCH',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(data)
						});

						const result = await res.json();
						console.log(result.message || result.error || 'Unknown response');

						renderSchedule();

					} catch (err) {
						console.error('Key update failed:', err);
					}
				});
				keyType.appendChild(keySelect);

				addTooltip(keyType, type.type);

				key.appendChild(keyType);
			});

			const spacer = document.createElement('span');
			spacer.classList.add('flex-grow');
			key.appendChild(spacer);

			const printBtn = document.createElement('button');
			printBtn.classList.add("fa", "fa-print");
			printBtn.id = "print-schedule";

			const loading = document.createElement('div');
			loading.classList.add('loading');

			printBtn.appendChild(loading);
			printBtn.addEventListener('click', async (e) => {
				e.target.disabled = true;
				loading.style.display = 'flex';
				const types = data
				const colorBlock = document.getElementById('color-block');
				const blockWKey = colorBlock.cloneNode(true);
				const toPrint = document.createElement('div');

				const colorKey = document.createElement('div');
				colorKey.classList.add('flex-row', 'print-key-container');
				types.forEach(type => {
					const key = document.createElement('div');
					key.textContent = type.type;
					key.style.backgroundColor = type.color;
					key.classList.add('print-key');
					colorKey.appendChild(key);
				});

				toPrint.appendChild(colorKey);
				toPrint.appendChild(blockWKey);

				await downloadElementAsPDF(toPrint);
				loading.style.display = "none";
				e.target.disabled = false;
			});

			key.appendChild(printBtn);

		} catch (err) {
			console.error(err);
		}
	}
</script>
</html>