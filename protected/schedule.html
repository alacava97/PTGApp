<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Convention Schedule</title>

	<link rel="stylesheet" href="public/styles/styles.css">
	<link rel="stylesheet" href="public/styles/buttons.css">
	<link rel="stylesheet" href="public/styles/themes.css">
	<link rel="stylesheet" href="public/styles/modals.css">
	<link rel="stylesheet" href="public/styles/nav-styles.css">
	<link rel="stylesheet" href="public/styles/schedule-styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
	<div id="navbar"></div>

	<header>
		<h1>Schedule</h1>
	</header>

	<section id="color-key" class="key"></section>
	<main id="color-block" class="schedule"></main>
</body>
<script src="public/js/script.js" defer></script>
<script src="public/js/modals.js" defer></script>
<script>
	document.addEventListener('DOMContentLoaded', initSchedule);

	async function initSchedule() {
		const classModal = new Modal('class-modal');
		classModal.content(`<h3>Select a Class</h3>
			<p id="period-info"></p>
			<form id="schedule-form" class="modal-form">
			    <input name="title" type="text" id="searchable" placeholder="Search classes">
				<ul id="results" class="drop-down-select"></ul>
				<div class="seperator"></div>
				<button type="submit">Add Class</button>
			</form>`);

		const eventModal = new Modal('event-modal');
		eventModal.content(`<h3><a id="class-title"></a></h3>
			<h4 id="inst"></h4>
			<a id="class-info">Review Form &#x1F517</a>
			<form id="update-sched">
				<label for="day">Day</label>
				<select id="day" name="day">
					<option value="3" selected>Wednesday</option>
					<option value="4">Thursday</option>
					<option value="5">Friday</option>
					<option value="6">Saturday</option>
				</select>
				<div class="seperator"></div>
				<label for="start_period">Period</label>
				<select id="start_period" name="start_period">
					<option value="1">Period 1</option>
					<option value="2">Period 2</option>
					<option value="3">Period 3</option>
					<option value="4">Period 4</option>
					<option value="5">Period 5</option>
				</select>
				<div class="seperator"></div>
				<label for="room_id">Room</label>
				<select name="room_id" id="room-dropdown"></select>
				<div class="seperator"></div>
				<label for="notes">Notes</label>
				<textarea name="notes" placeholder="notes" id="notes"></textarea>
				<button type="submit" id="edit-sched" class="button">Update</button>
			</form><br>
			<button id="confirm-delete" class="red delete">Delete</button>`);

		const deleteModal = new Modal('delete-confirmation-modal');
		deleteModal.content(`<h4>Remove event from calendar?</h4>
			<button id="delete-button" class="red delete">Delete</button>
		`);

		window.DOM = {
			classModal: document.getElementById('class-modal'),
			roomDropdown: document.getElementById('room-dropdown'),
			colorBlock: document.getElementById('color-block'),
			scheduleForm: document.getElementById('schedule-form'),
			searchable: document.getElementById('searchable'),
			results: document.getElementById('results'),
			periodInfo: document.getElementById('period-info'),
			classTitle: document.getElementById('class-title'),
			instructor: document.getElementById('inst'),
			classInfo: document.getElementById('class-info'),
			day: document.getElementById('day'),
			period: document.getElementById('start_period'),
			notes: document.getElementById('notes'),
			colorKey: document.getElementById('color-key')
		}

		try {
			const data = await ScheduleAPI.load();
			await renderKey(data.types, data.conventions);
			await renderSchedule(data.schedule, data.rooms);
			setupScheduleForm(data.classes, data.schedule);

			createSearchableDropdown('searchable', 'results', data.classes, 'title');

			Object.values(data.rooms).forEach(room => {
				const opt = document.createElement('option');
				opt.value = room.id;
				opt.textContent = room.name;
				DOM.roomDropdown.appendChild(opt);
			});
		} catch (err) {
			console.error('Failed to initialize schedule:', err);
		}
	}

	/* -----------------------------
	   Data Fetching
	----------------------------- */

	async function fetchJSON(url, options = {}) {
	  	const res = await fetch(url, options);
		if (!res.ok) throw new Error(await res.text());
		return res.json();
	}

	const ScheduleAPI = {
		load: async () => {
			const [schedule, rooms, types, conventions, classes] = await Promise.all([
				fetchJSON('/api/schedule'),
				fetchJSON('/api/read/rooms'),
				fetchJSON('/api/read/types'),
				fetchJSON('/api/read/conventions'),
				fetchJSON('/api/read/classes')
			]);
			return { schedule, rooms, types, conventions, classes };
		},

		updateTypeColor: (id, color) =>
		    fetchJSON(`/api/update/types/${id}`, {
		      	method: 'PATCH',
		      	headers: { 'Content-Type': 'application/json' },
		      	body: JSON.stringify({ color })
		    }),

	 	addSchedule: data =>
		    fetchJSON('/api/addSchedule', {
		      	method: 'POST',
		      	headers: { 'Content-Type': 'application/json' },
		      	body: JSON.stringify(data)
		    }),

		deleteSchedule: id =>
		    fetchJSON(`/api/delete/schedule/${id}`, { method: 'DELETE' })
	};


	/* -----------------------------
	   State
	----------------------------- */

	const ScheduleState = {
		selectedLocation: null
	};

	/* -----------------------------
	   Page Setup
	----------------------------- */

	function renderSchedulePage({ schedule, rooms, types, conventions }) {
		renderKey(types, conventions);
		renderSchedule(schedule, rooms);
	}

	/* -----------------------------
	   Schedule Setup
	----------------------------- */

	async function renderSchedule(schedule, rooms) {
		//render headers
		DOM.colorBlock.innerHTML = '';

		const days = ['Wednesday', 'Thursday', 'Friday', 'Saturday'];
		const periods = [1, 2, 3, 4, 5];

		renderDayHeaders(DOM.colorBlock, days, periods);
		renderRooms(DOM.colorBlock, schedule, rooms, days, periods);
	}

	function renderDayHeaders(calendar, days, periods) {
		const roomRow = document.createElement('div');
		roomRow.classList.add('cal-col', 'blank');
		calendar.appendChild(roomRow);

		days.forEach(day => {
			const dayHeader = document.createElement('div');
			const dayLabel = document.createElement('div');
			dayLabel.textContent = day;
			dayLabel.classList.add('day-label');
			dayHeader.appendChild(dayLabel);
			dayHeader.classList.add('cal-day', 'day-period');

			periods.forEach(period => {
				const block = document.createElement('div');
				block.textContent = period;
				block.classList.add('period');
				dayHeader.appendChild(block);
			})
			calendar.appendChild(dayHeader);
		});
	}

	function renderRooms(calendar, schedule, rooms, days, periods) {
		if (!rooms) {
			calendar.innerHTML = `No rooms on record`;
			calendar.style.backgroundColor = 'white';
			return
		}
		calendar.style.backgroundColor = '#333'

		for (const key in rooms) {
			const roomLabel = document.createElement('div');
			const roomName = rooms[key]['name'];
			const roomId = rooms[key].id;
			roomLabel.textContent = roomName
			roomLabel.classList.add('cal-col');
			calendar.appendChild(roomLabel);
			days.forEach((day, index) => {
			  	const roomDay = document.createElement('div');
			  	roomDay.classList.add('cal-day');

				const events = schedule.filter(e => e.day == (index + 3) && e.room_id == roomId);

				// check for overlaps
				const overlaps = checkOverlap(events);
				if (overlaps.length > 0) {
				  overlaps.forEach(o => {
				    console.warn(`Overlap detected in room "${roomName}" on ${day}: "${o.eventA.title}" at period ${o.eventA.start_period} overlaps with "${o.eventB.title}" at period ${o.eventB.start_period}`);
				  });
				}

			  // --- grid rendering with dummy cells ---
				let p = 1;
				while (p <= periods.length) {
				  const periodEvent = events.find(ev => ev.start_period == p);

				  if (periodEvent) {
				    const eventDiv = document.createElement('div');
				    eventDiv.classList.add('room-period');
				    eventDiv.textContent = periodEvent.title;
				    eventDiv.style.backgroundColor = periodEvent.color;

				    const start = Number(periodEvent.start_period);
				    const end = start + Number(periodEvent.length) - 1; // compute end from length
				    eventDiv.style.gridColumn = `${start} / ${end + 1}`;
				    eventDiv.id = periodEvent.schedule_id;

				    eventDiv.addEventListener('click', () => openEventModal(periodEvent));

				    roomDay.appendChild(eventDiv);

				    p = end + 1; // skip past this event
				  } else {
				    const dummy = document.createElement('div');
				    dummy.classList.add('room-period', 'empty');
				    dummy.textContent = p; 
				    dummy.id = 0;
				    const currentPeriod = p;

				    dummy.addEventListener('click', async () => {
				      	DOM.searchable.value = '';
				     	DOM.results.innerHTML = '';
				     	DOM.classModal.style.display = 'flex';
				     	DOM.periodInfo.textContent = `${day} - Period ${currentPeriod} - ${roomName}`;
				      	DOM.scheduleForm.dataset.day = index + 3;
				      	DOM.scheduleForm.dataset.period = currentPeriod;
				      	DOM.scheduleForm.dataset.room = parseInt(roomId);
				    });

				    roomDay.appendChild(dummy);
				    p++;
				  }
				}
			  calendar.appendChild(roomDay);
			});
		}
	}

	function setupScheduleForm(classes, schedule) {
		if (!DOM.scheduleForm) {
			console.error('form not found');
			return;
		} // guard

		DOM.scheduleForm.addEventListener('submit', async (e) => {
		    e.preventDefault();

		    const day = parseInt(DOM.scheduleForm.dataset.day);
		    const start_period = parseInt(DOM.scheduleForm.dataset.period);
		    const room = DOM.scheduleForm.dataset.room;
		    const title = DOM.searchable.value;

	        const selectedClass = classes.find(c => c.title == title);

		    if (!selectedClass) {
		    	alert(`Class "${title}" not found`);
		        return;
		    }

		    const length = selectedClass.length;
		    const newEnd = start_period + length - 1;

		    // Check period limit (cannot exceed 5)
		    if (newEnd > 5) {
		        alert(`Cannot schedule "${title}" after period 5`);
		        return;
		    }

	      	// Existing events in this room/day
	      	const roomEvents = schedule.filter(e => e.day == day && e.room == room);

	      	// Check for overlap
	      	const newEvent = { start_period, length, day, room, title };
	      	const allEvents = [...roomEvents, newEvent];

	      	const overlaps = checkOverlap(allEvents);

	      	const hasOverlap = overlaps.some(o =>
		        o.eventA == newEvent || o.eventB == newEvent
	      	);

	      	if (hasOverlap) {
				const conflict = overlaps.find(o =>
					o.eventA === newEvent || o.eventB === newEvent
				);

				const other = conflict.eventA === newEvent
					? conflict.eventB
					: conflict.eventA;

				alert(
					`Cannot add "${title}" because it overlaps with "${other.title}" at period ${other.start_period}`
				);
				return;
			}


	      	// No conflicts â†’ submit to backend
	      	const data = {
		      	class_id: parseInt(DOM.searchable.getAttribute('row-id')),
		      	day: day,
		      	start_period: start_period,
		      	room: parseInt(room)
	      	};

	      	await ScheduleAPI.addSchedule(data);

	      	alert('Class added!');
	      	DOM.classModal.style.display = 'none';

	      	// Refresh schedule display
	      	const updated = await ScheduleAPI.load();
	      	await renderSchedule(updated.schedule, updated.rooms);

	      	// Clear form
	      	DOM.scheduleForm.dataset.day = '';
	      	DOM.scheduleForm.dataset.period = '';
	      	DOM.scheduleForm.dataset.room = '';
	      	DOM.searchable.value = '';
	      	DOM.results.innerHTML = '';
		})
	}

	/* -----------------------------
	 	Modal Functions
	----------------------------- */

	function openEventModal(periodEvent) {
		fillEventModal(periodEvent);
		attachEventModalHandlers(periodEvent);
		showModal('event-modal');
	}

	function showModal(modalId) {
		const eventModal = document.getElementById(modalId);
	    eventModal.style.display = 'flex';
	}

	function fillEventModal(periodEvent) {
	    DOM.classTitle.innerHTML = `${periodEvent.title} &#9998;`;
	    DOM.classTitle.href = `/class-info.html?id=${periodEvent.class_id}`

	    DOM.instructor.textContent = periodEvent.instructors;
	    DOM.classInfo.href = `/public/class-review.html?id=${periodEvent.schedule_id}`
	    DOM.day.value = periodEvent.day;
	    DOM.period.value = periodEvent.start_period;
	    DOM.roomDropdown.value = periodEvent.room_id;
	    DOM.notes.value = periodEvent.notes;
	}

	function attachEventModalHandlers(periodEvent) {
		const form = document.getElementById('update-sched');
	    const cleanForm = form.cloneNode(true);
	    form.parentNode.replaceChild(cleanForm, form);
	    cleanForm.addEventListener('submit', (e) => {
	      	e.preventDefault();
	      	const id = periodEvent.schedule_id;
	      	handleFormSubmission(e, form, `/api/update/schedule/${id}`, 'PATCH', async () => {
				const updated = await ScheduleAPI.load();
					await renderSchedule(updated.schedule, updated.rooms);
			});
	    })

	    const delButton = document.getElementById('confirm-delete');
	    const cleanDelButton = delButton.cloneNode(true);
	    delButton.parentNode.replaceChild(cleanDelButton, delButton);
	    cleanDelButton.addEventListener('click', () => {
	      	document.getElementById('delete-confirmation-modal').style.display = 'flex';
	      	deleteButton(periodEvent.schedule_id);
	    });
	}

	function deleteButton(id) {
		const button = document.getElementById('delete-button');
		const freshButton = button.cloneNode(true);
		button.parentNode.replaceChild(freshButton, button);

		freshButton.addEventListener('click', async () => {
			await ScheduleAPI.deleteSchedule(id);	

			const updated = await ScheduleAPI.load();
      		await renderSchedule(updated.schedule, updated.rooms);
      		
			alert('event deleted');
			document.querySelectorAll('.modal').forEach(modal => {
				modal.style.display = 'none';
			})
		})
	}

	/* -----------------------------
	   	Type Legend
	----------------------------- */

	async function renderKey(types, conventions) {
		DOM.colorKey.innerHTML = '';

		types.forEach(type => DOM.colorKey.appendChild(renderTypeKey(type)));

		const spacer = document.createElement('span');
		spacer.classList.add('spacer');
		spacer.textContent = "Select Convention";
		DOM.colorKey.appendChild(spacer);

		DOM.colorKey.appendChild(await renderYearSelect());
		DOM.colorKey.appendChild(renderPrintButton(types));
	}

	async function updateTypeColor(id, val) {
		const data = { 'color': val };
		try {
			const res = await fetch(`/api/update/types/${id}`, {
				method: 'PATCH',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			const result = await res.json();
			console.log(result.message || result.error || 'Unknown response');

			const updated = await ScheduleAPI.load();;
  			await renderSchedule(updated.schedule, updated.rooms);
		} catch (err) {
			console.error('Error updating schedule:', err);
		}
	}

	function renderTypeKey(type) {
		const wrapper = document.createElement('div');
		wrapper.className = 'key-item';
		wrapper.style.backgroundColor = type.color;

		const input = document.createElement('input');
		input.type = 'color';
		input.value = type.color;

		input.classList.add('color-select');
		input.addEventListener('change', async (event) => {
			const input = event.target;
			await updateTypeColor(type.id, input.value);
		});

		wrapper.appendChild(input);
		addTooltip(wrapper, type.type);
		return wrapper;
	}

	function renderPrintButton(types) {
		const printBtn = document.createElement('button');
		printBtn.classList.add("fa", "fa-print");
		printBtn.id = "print-schedule";

		const loading = document.createElement('div');
		loading.classList.add('loading');

		printBtn.appendChild(loading);
		printBtn.addEventListener('click', async (e) => {
			e.target.disabled = true;
			loading.style.display = 'flex';
			const blockWKey = DOM.colorBlock.cloneNode(true);
			const toPrint = document.createElement('div');

			const colorKey = document.createElement('div');
			colorKey.classList.add('flex-row', 'print-key-container');
			types.forEach(type => {
				const key = document.createElement('div');
				key.textContent = type.type;
				key.style.backgroundColor = type.color;
				key.classList.add('print-key');
				colorKey.appendChild(key);
			});

			toPrint.appendChild(colorKey);
			toPrint.appendChild(blockWKey);

			await downloadElementAsPDF(toPrint);
			loading.style.display = "none";
			e.target.disabled = false;
		});

		return printBtn;
	}

	async function renderYearSelect() {
		const yearDd = document.createElement('select');
		yearDd.classList.add('year-select');
		yearDd.id = 'year-select';

		await populateYearDropdown(yearDd);

		yearDd.addEventListener('change', async () => {
			const updated = await ScheduleAPI.load();
      		await renderSchedule(updated.schedule, updated.rooms);
		});

		return yearDd;
	}

	/* -----------------------------
	 	Business Rules
	----------------------------- */

	function checkOverlap(events) {
	  const overlaps = [];

	  for (let i = 0; i < events.length; i++) {
	    for (let j = i + 1; j < events.length; j++) {
	      const a = events[i];
	      const b = events[j];

	      const aEnd = Number(a.start_period) + Number(a.length) - 1;
	      const bEnd = Number(b.start_period) + Number(b.length) - 1;

	      if (a.start_period <= bEnd && b.start_period <= aEnd) {
	        overlaps.push({ eventA: a, eventB: b });
	      }
	    }
	  }

	  return overlaps;
	}

	function hasOverlap(events) {
		return checkOverlap(events).length > 0;
	}


</script>
</html>