<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="styles.css">	
	<title>Instructor Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Instructor Profile</h1>
		<div id="back-btn" class="back-btn"><a href="/instructors.html">&#9664; Instructors</a></div>
	</header>
	<h2 id="instructor-name" class="info-header">Loading...</h2>
	<h3>Contact</h3>
	<div id="instructor-details" class="row">No Contact Found</div>

	<h3>Classes</h3>
	<div id="classes"></div>

	<h3>More Info</h3>
	<div id="more-info" class="row">No Extra Info</div>

	<div class="modal" id="contact-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Instructor Contact</h4>
			<form id="edit-contact">
				<label>Name
					<input type="text" name="name"required>
				</label><br><br>
				<label>Email
					<input type="email" name="email">
				</label><br><br>
				<label>Phone
					<input type="tel" name="phone">
				</label><br><br>
				<label>RPT Status
					<input class="small-input" type="checkbox" name="rpt">
				</label><br><br>
				<button type="submit">Update Record</button>
				<div id="message"></div>
			</form>
		</div>
	</div>
	<script src="/modals.js"></script>
	<script>
		async function loadInstructor() {
			const params = new URLSearchParams(window.location.search);
			const id = params.get('id');

			if (!id) {
				document.getElementById('instructor-name').textContent = 'Instrctor not found.';
				return;
			}

			try {
				const res = await fetch(`/api/instructors/${id}`);
				if (!res.ok) throw new Error('Network error');

				const instructor = await res.json();

				const name = document.getElementById('instructor-name');
				name.innerHTML = instructor.name;

				if (instructor.rpt === true) {
					name.innerHTML += ', RPT';
				}
				
				const contact = document.getElementById('instructor-details');
				contact.innerHTML = `<b>${instructor.name}</b>`;
				if (instructor.rpt === true) {
					contact.innerHTML += `<b>, RPT<b>`;
				}
				contact.innerHTML += `<br>${instructor.email || 'No email on record.'}<br>${instructor.phone || 'No phone on record.'}`;

				const arrow = document.createElement('span');
				arrow.innerHTML = `edit &#9654;`;
				arrow.classList.add("arrow");

				contact.appendChild(arrow);

				const classes = document.getElementById('classes');
				classes.innerHTML = '';

				const instClasses = await getClasses(id);
				if (instClasses.length === 0) {
					const emptyRow = document.createElement('div');
					emptyRow.classList.add('row');
					emptyRow.textContent = 'No classes found';
					classes.appendChild(emptyRow);
				} else {
					instClasses.forEach(entry => {
						const classRow = document.createElement('div');
						classRow.classList.add('row');
						classRow.innerHTML = `<b>${entry.title}</b><br>${entry.type_name}, ${entry.level}`

						const arrow2 = arrow.cloneNode(true);
						classRow.appendChild(arrow2);

						classes.appendChild(classRow);
					})
				}


				if (instructor.sponsored === true) {
					const moreInfo = document.getElementById('more-info');
					moreInfo.classList.add('row');
					moreInfo.innerHTML = `<b>Sponsored Instructor</b><br>${instructor.sponsor || 'No sponsor on record'}`;
					const arrow3 = arrow.cloneNode(true);
					moreInfo.appendChild(arrow3);
				}

			} catch (err) {
				console.error('Error loading instructor:', err);
				document.getElementById('instructor-name').textContent = 'Error loading instructor.';
			}
		}

		async function getClasses(instructor_id) {
			try {
				const res = await fetch(`/api/classByInst/${instructor_id}`);
				if (!res.ok) throw new Error('Network error');

				const classList = await res.json();

				return classList;
			} catch (err) {
				console.error('Internal server error:', err);
			}
		}

		async function populateModals(id) {
			const editContact = document.getElementById('edit-contact');
			try {
				const res = await fetch(`/api/instructors/${id}`);
				const instData = await res.json();
				const inputs = editContact.querySelectorAll('input');
				inputs.forEach(input => {
					if (input.type === 'checkbox') {
						input.checked = !!instData[input.name];
					} else {
						input.value = instData[input.name];
					}
				});
			} catch (err) {
				console.error('Internal server error:', err);
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			const params = new URLSearchParams(window.location.search);
			const id = params.get('id');

			populateModals(id);
			loadInstructor();

			const contact = document.getElementById('instructor-details');
			const classes = document.getElementById('classes');
			const moreInfo = document.getElementById('more-info');

			contact.addEventListener('click', () => {
				const contactModal = document.getElementById('contact-modal');
				contactModal.style.display = "flex";
			});
		});

		async function updateRecord(table, id, data) {
			try {
			const res = await fetch(`/api/update/${table}/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			});
			if (!res.ok) throw new Error('Network response was not ok');
			const result =  await res.json();
			return result;
			} catch (err) {
				console.error('Internal server error:', err);
				return { error: 'Request failed' };
			}
		}

		const form = document.getElementById('edit-contact');
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			const params = new URLSearchParams(window.location.search);
			const id = params.get('id');

			const formData = new FormData(form);
			const data = {};

			for (let [key, value] of formData.entries()) {
				if (value === 'on') {
					data[key] = true;
				} else if (value === '') {
					data[key] = null;
				} else {
					data[key] = value;
				}
			}

			form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
				if (!formData.has(checkbox.name)) {
					data[checkbox.name] = false;
				}
			});

			const result = await updateRecord('instructors', id, data);

			const message = document.getElementById('message');
			message.textContent = result.message || result.error || 'Unknown response';

			await populateModals(id);
			document.getElementById('contact-modal').style.display = "none";
			await loadInstructor(id);

		});
	</script>
</body>
</html>