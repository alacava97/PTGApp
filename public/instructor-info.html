<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="styles.css">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
	<title>Instructor Info</title>
</head>
<body>
	<header class="clearfix">
		<h1>Instructor Profile</h1>
		<div id="back-btn" class="back-btn"><a href="/instructors.html">&#9664; Instructors</a></div>
	</header>
	<h2 id="instructor-name" class="info-header">Loading...</h2>
	<h3>Contact</h3>
	<div id="instructor-details" class="row">No Contact Found</div>

	<div class="clearfix"><h3>Classes</h3>
	<div id="classes"></div>

	<h3>More Info</h3>
	<div id="more-info" class="row">No Extra Info</div>

	<div class="modal" id="contact-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Instructor Contact</h4>
			<form id="edit-contact">
				<label>Name
					<input type="text" name="name"required>
				</label><br><br>
				<label>Email
					<input type="email" name="email">
				</label><br><br>
				<label>Phone
					<input type="tel" name="phone">
				</label><br><br>
				<label>RPT Status
					<input class="small-input" type="checkbox" name="rpt">
				</label><br><br>
				<button type="submit">Update Record</button>
				<div id="message"></div>
			</form>
		</div>
	</div>

	<div class="modal" id="delete-confirmation-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Remove class from instructor record?</h4>
			<div>
				<button id="delete-button" class="delete-button">Delete</button>
			</div>
		</div>
	</div>

	<div class="modal" id="class-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Select a Class</h4>
			<form id="instructor-class-form">
			    <input name="title" type="text" id="searchable" placeholder="Search classes">
				<ul id="results" class="drop-down-select"></ul><br>
				<button type="submit">Add Class</button>
			</form>
		</div>
	</div>

	<div class="modal" id="sponsor-modal">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h4>Instructor Sponsor</h4>
			<form id="edit-sponsor">
				<label>Sponsored
					<input id="sponsored" class="small-input" type="checkbox" name="sponsored">
				</label><br><br>
				<label id="sponsor">Sponsor
					<input type="text" name="sponsor" autocomplete="off" placeholder="Sponsor"><br><br>
				</label>
				<button type="submit">Update Sponsor</button>
			</form>
		</div>
	</div>
</body>
<script src="script.js"></script>
<script>
	async function getClasses(instructor_id) {
		try {
			const res = await fetch(`/api/classByInst/${instructor_id}`);
			if (!res.ok) throw new Error('Network error');

			const classList = await res.json();

			return classList;
		} catch (err) {
			console.error('Internal server error:', err);
		}
	}

	document.addEventListener('DOMContentLoaded', async () => {
		const id = getInstructorId();

		await populateModals(id);
		await loadInstructor(id);
		modalButtons();
		sponsorCheck();

		const contact = document.getElementById('instructor-details');
		const classes = document.getElementById('classes');
		const moreInfo = document.getElementById('more-info');

		contact.addEventListener('click', () => {
			const modal = document.getElementById('contact-modal')
			modal.style.display = "flex";
			modal.querySelector('#message').innerHTML = '';
		});

		moreInfo.addEventListener('click', () => {
			document.getElementById('sponsor-modal').style.display = "flex";
		});

		document.querySelectorAll('form').forEach(form => {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				if (form.id === 'instructor-class-form') {
					const data = parseForm(form);
					await linkInstructorToClass(id, data.title);
					await loadInstructor(id);
					const classModal = form.closest('.modal')
					classModal.style.display = 'none';
					form.reset();
				} else {
					const id = getInstructorId();
					handleFormSubmission(e, form, `/api/update/instructors/${id}`, 'PATCH', async () => {
						await populateModals(id);
						await loadInstructor(id);
					});
				}
			});
		});

		const sponsored = document.getElementById('sponsored');
		sponsored.addEventListener('change', sponsorCheck);

		const classData = await read('classes');
		const titles = classData.map(item => item.title);
		createSearchableDropdown('searchable', 'results', titles);
	});

	function getInstructorId() {
		return new URLSearchParams(window.location.search).get('id');
	}

</script>
</html>