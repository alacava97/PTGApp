<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="styles.css">
	<title>Instructors</title>
</head>
<body>
	<div id="navbar"></div>
	<header class="clearfix">
		<h1>Instructors</h1>
		<div id="new-btn" class="new-btn">new</div>
	</header>
	<input class="searchbar" type="text" name="searchbar" placeholder="Search by name, phone, email, etc.">

	<div id="instList"></div>

	<div class="modal" id="newInst">
		<div class="modal-content">
			<div class="close-btn" id="close-btn">&times;</div>
			<h2>New Instructor</h2>
			<form id="new-instructor-form">
				<label>Name:
					<input type="text" name="name" placeholder="Name" autocomplete="off" required>
				</label><br><br>
				<label>Phone:
					<input type="tel" name="phone" autocomplete="off" placeholder="Phone" required>
				</label><br><br>
				<label>Email:
					<input type="email" name="email" autocomplete="off" placeholder="Email" required>
				</label><br><br>
				<label>RPT Status:
					<input type="checkbox" name="rptStatus" >
				</label><br><br>
				<label>Sponsored:
					<input type="checkbox" name="sponsored" >
				</label><br><br>
				<button type="submit">Create Record</button>
			</form>

			<div id="message"></div>

		</div>
	</div>
</body>
<script src="script.js"></script>
<script>
	const form = document.getElementById('new-instructor-form');
	const message = document.getElementById('message');

	form.addEventListener('submit', async (e) => {
		e.preventDefault();

		const formData = new FormData(form);
		const data = {
			name: formData.get('name'),
			phone: formData.get('phone'),
			email: formData.get('email'),
			rpt: formData.get('rptStatus') || false,
			sponsored: formData.get('sponsored') || false
		};

		try {
			const res = await fetch('/api/newInstructor', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			const result = await res.json();
			message.textContent = result.message || result.error || 'Unknown response';

			if (res.ok) {
				form.reset();
				loadInstructors();
			}
		} catch (error) {
			console.error('Request failed:', error);
			message.textContent = 'Network error or server issue';
		}
	});

	document.addEventListener('DOMContentLoaded', function () {
	  	const modal = document.getElementById('newInst');
		const closeBtn = document.getElementById('close-btn');
		const openBtn = document.getElementById('new-btn');

		closeBtn.addEventListener('click', function () {
			modal.style.display = 'none';
		});

		openBtn.addEventListener('click', function () {
			modal.style.display = 'flex';
		});

		modal.addEventListener('click', function (event) {
			if (event.target === modal) {
		  		modal.style.display = 'none';
			}
		});
	});

	let allInstructors = [];

	async function loadInstructors() {
		const instList = document.getElementById('instList');
		instList.innerHTML = '';

		try {
			const response = await fetch('/api/getInstructors');
			if (!response.ok) throw new Error('Network response was not ok');

			allInstructors = await response.json();
			displayInstructors(allInstructors);
		} catch (err) {
			console.error('Failed to load instructors:', err);
		}
	}

	const searchBar = document.querySelector('.searchbar');
	searchBar.addEventListener('input', () => {
		const term = searchBar.value.toLowerCase();
		const filtered = allInstructors.filter(inst => {
			return (
				inst.name?.toLowerCase().includes(term) ||
				inst.phone?.toLowerCase().includes(term) ||
				inst.email?.toLowerCase().includes(term) ||
				(inst.rpt ? 'rpt' : '').includes(term) ||
				(inst.sponsored ? 'sponsored': '').includes(term)
			);
		});
		displayInstructors(filtered);
	});

	function displayInstructors(instructors) {
		const instList = document.getElementById('instList');
		instList.innerHTML = '';

		instructors.forEach(instructor => {
			const entry = document.createElement('div');
			entry.classList.add('row');

			const name = document.createElement('span');
			if (instructor.rpt === true) {
				name.textContent = instructor.name + ', RPT';
			} else {
				name.textContent = instructor.name;
			};

			const arrow = document.createElement('span')
			arrow.innerHTML = `&#9654;`;
			arrow.classList.add("arrow");

			entry.appendChild(name);
			entry.appendChild(arrow);

			entry.addEventListener('click', () => {
				window.location.href = `/instructor-info.html?id=${instructor.id}`;
			});

			instList.appendChild(entry);
		});
	}

	document.addEventListener('DOMContentLoaded', loadInstructors);
</script>
</html>